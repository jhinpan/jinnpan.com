---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import ArrowCard from "@components/ArrowCard.astro";
import BackToPrevious from "@components/BackToPrevious.astro";
import { getPostLang } from "@lib/utils";
import type { Lang } from "@lib/utils";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => !data.draft);
  const langs: Lang[] = ["zh", "en"];

  return langs.flatMap((lang) => {
    const langPosts = posts.filter((post) => getPostLang(post.id) === lang);
    const tags = [...new Set(langPosts.flatMap((post) => post.data.tags || []))];
    return tags.map((tag) => ({
      params: { lang, id: tag },
      props: {
        posts: langPosts.filter((post) => post.data.tags?.includes(tag)),
      },
    }));
  });
}

const { lang, id } = Astro.params as { lang: Lang; id: string };
const { posts } = Astro.props;

const sortedPosts = posts.sort(
  (a: any, b: any) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);
---

<Layout title={`Tag: ${id}`} description={`Posts with the tag: ${id}`} lang={lang}>
  <Container>
    <div class="space-y-10" data-pagefind-ignore>
      <BackToPrevious href={`/${lang}/tags`}>
        {lang === "zh" ? "所有标签" : "All tags"}
      </BackToPrevious>
      <h1 class="animate font-semibold text-black dark:text-white">
        {lang === "zh" ? `标签: "${id}"` : `Posts tagged with "${id}"`}
      </h1>
      <ul class="animate flex flex-col gap-4">
        {sortedPosts.map((post: any) => <ArrowCard entry={post} />)}
      </ul>
    </div>
  </Container>
</Layout>
